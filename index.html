<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soccerverse Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0b0914;--bg2:#13101f;--bg3:#16132a;--border:#1e1b2e;--border2:#2d2640;
    --text:#e2e0eb;--text2:#94a3b8;--text3:#64748b;--purple:#a78bfa;--purple2:#c084fc;
    --purple3:#7c3aed;--green:#10b981;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;
    --orange:#f97316;--cyan:#06b6d4;
  }
  body{background:var(--bg);color:var(--text);font-family:'DM Sans','Segoe UI',sans-serif;min-height:100vh}
  ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

  .header{padding:20px 32px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--bg2) 0%,var(--bg) 100%)}
  .header-inner{display:flex;align-items:center;justify-content:space-between;max-width:900px;margin:0 auto;flex-wrap:wrap;gap:12px}
  .logo{font-size:26px;font-family:'Playfair Display',serif;font-weight:800;background:linear-gradient(135deg,#c084fc,#a78bfa,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .subtitle{margin-top:4px;font-size:11px;color:var(--text3);letter-spacing:1px}
  .tabs{display:flex;gap:4px;background:var(--bg2);border-radius:12px;padding:4px;border:1px solid var(--border)}
  .tab-btn{padding:8px 16px;border-radius:8px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;background:transparent;color:var(--text2);font-family:inherit}
  .tab-btn.active{background:linear-gradient(135deg,var(--purple3),var(--purple));color:#fff}
  .content{max-width:900px;margin:0 auto;padding:24px 32px}

  .status-bar{padding:8px 16px;background:rgba(167,139,250,.07);border:1px solid var(--border2);border-radius:10px;color:var(--purple);margin-bottom:16px;font-size:12px;animation:pulse 1.5s infinite;display:flex;align-items:center;gap:8px}
  .status-dot{width:8px;height:8px;border-radius:50%;background:var(--purple)}
  .error-box{padding:16px;background:rgba(239,68,68,.13);border:1px solid var(--red);border-radius:12px;color:#fca5a5;margin-bottom:20px;font-size:13px}
  .error-box h3{font-weight:700;margin-bottom:6px}
  .error-box .hint{font-size:11px;color:rgba(248,113,113,.6);margin:8px 0}
  .retry-btn{margin-top:8px;padding:6px 14px;border-radius:8px;border:1px solid var(--red);background:transparent;color:#fca5a5;font-size:12px;cursor:pointer;font-weight:600;font-family:inherit}

  .search-bar{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
  .search-input{padding:10px 16px;border-radius:10px;border:1px solid var(--border2);background:var(--bg2);color:var(--text);font-size:13px;outline:none;font-family:inherit;flex:1;min-width:180px}
  .filter-select{padding:10px 14px;border-radius:10px;border:1px solid var(--border2);background:var(--bg2);color:var(--text);font-size:13px;outline:none;font-family:inherit}
  .sort-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border2);background:var(--bg2);color:var(--purple);font-size:13px;cursor:pointer;font-weight:600;font-family:inherit}
  .count{color:var(--text3);font-size:12px;margin-left:auto}

  .player-list{display:flex;flex-direction:column;gap:8px}
  .player-row{background:linear-gradient(135deg,var(--bg3) 0%,#0f0d1a 100%);border-radius:14px;padding:14px 20px;border:1px solid var(--border);cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:16px}
  .player-row:hover{border-color:var(--purple3);transform:translateY(-1px);box-shadow:0 4px 20px rgba(124,58,237,.1)}
  .player-info{flex:1;min-width:0}
  .player-name{font-weight:700;font-size:15px;color:#f1f0f5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .player-meta{font-size:11px;color:var(--text2);margin-top:2px}
  .player-stats-mini{display:flex;gap:12px;font-size:11px;margin-top:4px;flex-wrap:wrap}
  .player-stats-mini span{color:var(--text3)}
  .player-stats-mini b{color:var(--text);font-weight:600}
  .player-rating-box{padding:6px 12px;border-radius:10px;font-size:20px;font-weight:800;color:#fff;flex-shrink:0;text-align:center;min-width:50px}
  .player-sparkline{flex-shrink:0}

  .grid{display:grid;gap:12px}
  .grid-clubs{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
  .grid-leagues{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
  .grid-market{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
  .card{background:linear-gradient(135deg,var(--bg3) 0%,#0f0d1a 100%);border-radius:14px;padding:18px;border:1px solid var(--border);cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
  .card:hover{border-color:var(--purple3);transform:translateY(-2px)}
  .market-card{background:linear-gradient(135deg,var(--bg3) 0%,#0f0d1a 100%);border-radius:14px;padding:20px;border:1px solid var(--border);position:relative;overflow:hidden}
  .market-icon{position:absolute;top:12px;right:14px;font-size:24px;opacity:.2}
  .market-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
  .market-val{font-size:20px;font-weight:700}

  .bar-wrap{display:flex;align-items:center;gap:6px}
  .bar-bg{width:80px;height:6px;background:var(--border);border-radius:3px}
  .bar-fill{height:100%;border-radius:3px;transition:width .6s ease}
  .bar-val{font-size:11px;color:var(--purple);font-weight:600;min-width:22px}
  .form-dots{display:flex;gap:3px}
  .form-dot{width:16px;height:16px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff}
  .form-W{background:var(--green)}.form-D{background:var(--yellow)}.form-L{background:var(--red)}.form-X{background:#475569}

  .stat-box{background:var(--bg2);border-radius:10px;padding:10px 12px;border:1px solid var(--border)}
  .stat-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
  .stat-val{font-size:14px;color:var(--text);font-weight:600}
  .spinner{display:flex;justify-content:center;padding:60px}
  .spinner-ring{width:36px;height:36px;border:3px solid var(--border2);border-top-color:var(--purple);border-radius:50%;animation:spin .8s linear infinite}
  .empty{text-align:center;padding:60px;color:var(--text3)}
  .empty-icon{font-size:40px;margin-bottom:12px}
  .pagination{display:flex;justify-content:center;gap:8px;margin-top:20px}
  .pg-btn{padding:8px 16px;border-radius:8px;border:1px solid var(--border2);background:var(--bg2);color:var(--purple);font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
  .pg-btn:disabled{opacity:.4;cursor:default}
  .pg-info{color:var(--text2);font-size:12px;padding:8px 12px}

  .modal-overlay{position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;padding:20px}
  .modal{background:linear-gradient(135deg,#1a1528 0%,#0f0d1a 100%);border-radius:20px;border:1px solid var(--border2);max-width:540px;width:100%;padding:32px;position:relative;box-shadow:0 40px 80px rgba(0,0,0,.6);max-height:90vh;overflow-y:auto}
  .modal-wide{max-width:720px}
  .modal-close{position:absolute;top:16px;right:16px;background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;z-index:10}
  .modal h2{margin:0 0 20px;font-size:22px;color:#f1f0f5;font-family:'Playfair Display',serif}

  table{width:100%;border-collapse:separate;border-spacing:0 3px;font-size:12px}
  th{padding:6px 8px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;font-size:9px;font-weight:600}
  td{padding:8px}
  tr.stripe{background:#0f0d1a}
  tr.top{background:rgba(167,139,250,.07)}
  .fade-in{animation:fadeIn .4s ease}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <div>
      <div class="logo">‚öΩ Soccerverse</div>
      <div class="subtitle">LIVE DATACENTRE DASHBOARD</div>
    </div>
    <div class="tabs" id="tabs"></div>
  </div>
</div>
<div class="content" id="content"></div>
<div id="modal-root"></div>

<script>
const API = "https://services.soccerverse.com/api";
const PROXIES = [
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => url
];
let bestProxy = 0;

let state = {
  tab: "players",
  players: [], playerTotal: 0, playerPage: 1, playerSort: "rating", playerOrder: "desc", playerPos: "", playerSearch: "",
  clubs: [], clubTotal: 0, clubPage: 1,
  leagues: [],
  market: null,
  loading: false, error: null, status: "",
  modal: null,
  leagueTable: [],
};

function setState(patch) { Object.assign(state, patch); render(); }

let abortCtrl = null;
async function apiFetch(endpoint, params = {}) {
  if (abortCtrl) abortCtrl.abort();
  abortCtrl = new AbortController();
  const url = new URL(API + endpoint);
  for (const [k,v] of Object.entries(params)) { if (v != null && v !== "") url.searchParams.set(k, v); }
  const raw = url.toString();
  const order = [bestProxy, ...Array.from({length:PROXIES.length},(_,i)=>i).filter(i=>i!==bestProxy)];
  for (const i of order) {
    try {
      const r = await fetch(PROXIES[i](raw), {signal:abortCtrl.signal, headers:{Accept:"application/json"}});
      if (r.status===429){await new Promise(r=>setTimeout(r,2500));const r2=await fetch(PROXIES[i](raw),{signal:abortCtrl.signal});if(r2.ok){bestProxy=i;return r2.json()}continue}
      if (!r.ok) continue;
      bestProxy=i; return r.json();
    } catch(e) { if(e.name==="AbortError") throw e; continue; }
  }
  throw new Error("Could not reach the Soccerverse API. Try refreshing.");
}

// ---- Helpers ----
const fmt = n => n != null ? Number(n).toLocaleString() : "‚Äî";
const fmtSVC = n => {
  if (n == null) return "‚Äî";
  const v = Number(n) / 10000;
  if (v >= 1000000) return (v/1000000).toFixed(2) + "M SVC";
  if (v >= 1000) return (v/1000).toFixed(1) + "K SVC";
  return v.toFixed(2) + " SVC";
};
const posNum = n => ({1:"GK",2:"DEF",3:"MID",4:"FWD"}[n] || "?");
const posClr = p => ({GK:"#f59e0b",DEF:"#3b82f6",MID:"#10b981",FWD:"#ef4444"}[p] || "#94a3b8");

function barHTML(val, max=100, color="#a78bfa") {
  const pct = Math.min(((val||0)/max)*100,100);
  return `<div class="bar-wrap"><div class="bar-bg"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div><span class="bar-val">${val??"‚Äî"}</span></div>`;
}
function formHTML(form) {
  if(!form)return "";
  return `<div class="form-dots">${form.split("").slice(-5).map(c=>`<span class="form-dot form-${c==='W'||c==='D'||c==='L'?c:'X'}">${c}</span>`).join("")}</div>`;
}
function sparkSVG(data, w=80, h=24, color="#a78bfa") {
  if(!data||!data.length||data.every(v=>v===0)) return `<span style="color:#333;font-size:9px">‚Äî</span>`;
  const mn=Math.min(...data),mx=Math.max(...data),rng=mx-mn||1;
  const pts=data.map((v,i)=>`${(i/(data.length-1))*w},${h-((v-mn)/rng)*h}`).join(" ");
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

// ---- Data loading ----
async function loadData() {
  setState({loading:true, error:null, status:"Connecting to Soccerverse API..."});
  try {
    if (state.tab==="players") {
      const p = {page:state.playerPage, per_page:20, sort_by:state.playerSort, sort_order:state.playerOrder};
      if (state.playerPos) p.positions = state.playerPos;
      if (state.playerSearch) {
        const s = state.playerSearch.trim();
        if (/^\d+$/.test(s)) p.player_id = s;
        else p.owned = s;
      }
      const d = await apiFetch("/players/detailed", p);
      setState({players:d.items||[], playerTotal:d.total||0, loading:false, status:""});
    } else if (state.tab==="clubs") {
      const d = await apiFetch("/clubs/detailed", {page:state.clubPage, per_page:20, sort_by:"avg_player_rating", sort_order:"desc"});
      setState({clubs:d.items||[], clubTotal:d.total||0, loading:false, status:""});
    } else if (state.tab==="leagues") {
      const d = await apiFetch("/leagues", {page:1, per_page:50, sort_by:"market_cap", sort_order:"desc"});
      setState({leagues:d.items||[], loading:false, status:""});
    } else if (state.tab==="market") {
      const d = await apiFetch("/market");
      setState({market:d, loading:false, status:""});
    }
  } catch(e) {
    if (e.name!=="AbortError") setState({error:e.message, loading:false, status:""});
  }
}

async function loadLeagueTable(league) {
  setState({modal:{type:"league",data:league}, leagueTable:[], loading:true});
  try {
    const d = await apiFetch("/league_tables", {league_id:league.league_id});
    setState({leagueTable:Array.isArray(d)?d:(d.items||[]), loading:false, status:""});
  } catch(e) { setState({leagueTable:[], loading:false, status:""}); }
}

// ---- Render ----
function render() {
  document.getElementById("tabs").innerHTML = [
    {id:"players",l:"‚öΩ Players"},{id:"clubs",l:"üèü Clubs"},{id:"leagues",l:"üèÜ Leagues"},{id:"market",l:"üìä Market"}
  ].map(t=>`<button class="tab-btn ${state.tab===t.id?'active':''}" onclick="switchTab('${t.id}')">${t.l}</button>`).join("");

  const c = document.getElementById("content");
  let html = "";
  if (state.status) html += `<div class="status-bar"><div class="status-dot"></div>${state.status}</div>`;
  if (state.error) html += `<div class="error-box"><h3>‚ö† Connection Error</h3><div>${state.error}</div><div class="hint">The dashboard routes through CORS proxies. Try clicking Retry.</div><button class="retry-btn" onclick="loadData()">üîÑ Retry</button></div>`;

  if (state.tab==="players") html += renderPlayers();
  else if (state.tab==="clubs") html += renderClubs();
  else if (state.tab==="leagues") html += renderLeagues();
  else if (state.tab==="market") html += renderMarket();
  c.innerHTML = `<div class="fade-in">${html}</div>`;

  const mr = document.getElementById("modal-root");
  if (state.modal) {
    if (state.modal.type==="player") mr.innerHTML = renderPlayerModal(state.modal.data);
    else if (state.modal.type==="club") mr.innerHTML = renderClubModal(state.modal.data);
    else if (state.modal.type==="league") mr.innerHTML = renderLeagueModal();
    else mr.innerHTML = "";
  } else mr.innerHTML = "";
}

function renderPlayers() {
  let h = `<div class="search-bar">
    <input class="search-input" placeholder="Search by Player ID or agent name..." value="${state.playerSearch}" oninput="debounceSearch(this.value)">
    <select class="filter-select" onchange="updateFilter('playerPos',this.value)">
      <option value="" ${!state.playerPos?"selected":""}>All Pos</option>
      <option value="GK" ${state.playerPos==="GK"?"selected":""}>GK</option>
      <option value="DEF" ${state.playerPos==="DEF"?"selected":""}>DEF</option>
      <option value="MID" ${state.playerPos==="MID"?"selected":""}>MID</option>
      <option value="FWD" ${state.playerPos==="FWD"?"selected":""}>FWD</option>
    </select>
    <select class="filter-select" onchange="updateFilter('playerSort',this.value)">
      ${["rating","value","wages","age","rating_shooting","rating_passing","rating_tackling"].map(s=>`<option value="${s}" ${state.playerSort===s?"selected":""}>${s.replace("rating_","").replace(/^\w/,c=>c.toUpperCase())}</option>`).join("")}
    </select>
    <button class="sort-btn" onclick="toggleOrder()">${state.playerOrder==="desc"?"‚Üì Desc":"‚Üë Asc"}</button>
    <span class="count">${fmt(state.playerTotal)} players</span>
  </div>`;

  if (state.loading) return h + `<div class="spinner"><div class="spinner-ring"></div></div>`;
  if (!state.players.length && !state.error) return h + `<div class="empty"><div class="empty-icon">‚öΩ</div>No players found. Try a different search.</div>`;

  h += `<div class="player-list">`;
  for (const p of state.players) {
    const pc = posClr(posNum(p.position));
    h += `<div class="player-row" onclick="openPlayer(${p.player_id})">
      <div style="width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,${pc},#1e1b2e);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff;flex-shrink:0">${p.rating}</div>
      <div class="player-info">
        <div class="player-name">Player #${p.player_id}</div>
        <div class="player-meta">${(p.positions||[]).join(" / ")} ¬∑ Age ${p.age} ¬∑ ${p.country_id} ¬∑ Club #${p.club_id}${p.agent_name ? ` ¬∑ Agent: ${p.agent_name}` : ""}</div>
        <div class="player-stats-mini">
          <span>Value: <b style="color:var(--purple2)">${fmtSVC(p.value)}</b></span>
          <span>Wages: <b>${fmtSVC(p.wages)}</b></span>
          <span>Shot: <b style="color:var(--red)">${p.rating_shooting??"-"}</b></span>
          <span>Pass: <b style="color:var(--blue)">${p.rating_passing??"-"}</b></span>
          <span>Tck: <b style="color:var(--green)">${p.rating_tackling??"-"}</b></span>
        </div>
      </div>
      <div class="player-sparkline">${sparkSVG(p.last_7days,60,22)}</div>
    </div>`;
  }
  h += `</div>`;
  h += paginationHTML(state.playerPage, state.playerTotal, 20, "setPlayerPage");
  return h;
}

function renderPlayerModal(p) {
  const pc = posClr(posNum(p.position));
  const ratings = [["Overall",p.rating,"#a78bfa"],["Shooting",p.rating_shooting,"#ef4444"],["Passing",p.rating_passing,"#3b82f6"],["Tackling",p.rating_tackling,"#10b981"],["GK",p.rating_gk,"#f59e0b"],["Stamina",p.rating_stamina,"#06b6d4"],["Aggression",p.rating_aggression,"#f97316"]];
  const payout = p.wages != null ? ((Number(p.wages) / 10000) * 0.002) : null;
  const payoutStr = payout != null ? payout.toFixed(2) + " SVC" : "‚Äî";
  const stats = [["Value",fmtSVC(p.value)],["Wages",fmtSVC(p.wages)],["Payout (0.2%)",payoutStr],["Contract",p.contract],["Fitness",p.fitness],["Morale",p.morale],["Form",p.form,true],["Yellow Cards",p.yellow_cards],["Red Cards",p.red_cards],["Last Price",fmtSVC(p.last_price)],["7d Volume",fmtSVC(p.volume_7_day)],["1d Volume",fmtSVC(p.volume_1_day)]];

  return `<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div style="display:flex;gap:20px;align-items:center;margin-bottom:24px">
      <div style="width:72px;height:72px;border-radius:16px;background:linear-gradient(135deg,${pc},#1e1b2e);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:#fff;border:2px solid rgba(255,255,255,.1);flex-shrink:0">${p.rating}</div>
      <div>
        <h2 style="margin:0 0 6px">Player #${p.player_id}</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          ${(p.positions||[]).map(pos=>{const c=posClr(pos);return `<span style="padding:2px 10px;border-radius:20px;font-size:11px;font-weight:700;background:${c}22;color:${c};border:1px solid ${c}44">${pos}</span>`;}).join("")}
          <span style="font-size:11px;color:var(--text2)">Age ${p.age} ¬∑ ${p.country_id} ¬∑ Club #${p.club_id}</span>
        </div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
      ${ratings.map(([l,v,c])=>`<div><div class="stat-label">${l}</div>${barHTML(v,100,c)}</div>`).join("")}
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px">
      ${stats.map(([l,v,isForm])=>`<div class="stat-box"><div class="stat-label">${l}</div>${isForm?formHTML(v):`<div class="stat-val">${v??"‚Äî"}</div>`}</div>`).join("")}
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <span class="stat-label">7d Vol</span>${sparkSVG(p.last_7days,110,26)}
      <span class="stat-label" style="margin-left:8px">7d Price</span>${sparkSVG(p.last_7days_price,110,26,"#10b981")}
    </div>
    ${p.agent_name?`<div style="margin-top:16px;font-size:12px;color:var(--text2)">Agent: <span style="color:var(--purple2);font-weight:600">${p.agent_name}</span></div>`:""}
  </div></div>`;
}

function renderClubs() {
  if (state.loading) return `<div class="spinner"><div class="spinner-ring"></div></div>`;
  if (!state.clubs.length&&!state.error) return `<div class="empty"><div class="empty-icon">üèü</div>No clubs loaded.</div>`;
  let h = `<div class="grid grid-clubs">`;
  for (const c of state.clubs) {
    h += `<div class="card" onclick="openClub(${c.club_id})">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
        <div><div style="font-weight:700;font-size:16px;color:#f1f0f5">Club #${c.club_id}</div><div style="font-size:11px;color:var(--text2)">${c.country_id} ¬∑ Div ${c.division}</div></div>
        <div style="padding:4px 10px;border-radius:8px;background:rgba(167,139,250,.13);color:var(--purple);font-size:18px;font-weight:800">${c.avg_player_rating?.toFixed(1)??"‚Äî"}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:11px;margin-bottom:12px">
        <div><div style="color:var(--text3);font-size:9px;text-transform:uppercase">Balance</div><div style="color:var(--green);font-weight:600">${fmtSVC(c.balance)}</div></div>
        <div><div style="color:var(--text3);font-size:9px;text-transform:uppercase">Wages</div><div style="color:var(--yellow);font-weight:600">${fmtSVC(c.total_wages)}</div></div>
        <div><div style="color:var(--text3);font-size:9px;text-transform:uppercase">Fans</div><div style="color:var(--text);font-weight:600">${fmt(c.fans_current)}</div></div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">${sparkSVG(c.last_7days,100,24)}${c.manager_name?`<span style="font-size:10px;color:var(--text3);margin-left:auto">üßë‚Äçüíº ${c.manager_name}</span>`:""}</div>
    </div>`;
  }
  h += `</div>`;
  h += paginationHTML(state.clubPage, state.clubTotal, 20, "setClubPage");
  return h;
}

function renderClubModal(c) {
  const stats = [["Balance",fmtSVC(c.balance)],["Value",fmtSVC(c.value)],["Avg Rating",c.avg_player_rating?.toFixed(1)],["Top21 Avg",c.avg_player_rating_top21?.toFixed(1)],["Total Wages",fmtSVC(c.total_wages)],["Avg Wages",fmtSVC(c.avg_wages)],["Fans",fmt(c.fans_current)],["Stadium",fmt(c.stadium_size_current)],["Division",c.division],["Transfers In",fmt(c.transfers_in)],["Transfers Out",fmt(c.transfers_out)],["Last Price",fmtSVC(c.last_price)]];
  const skills = [["Shooting",c.avg_shooting,"#ef4444"],["Passing",c.avg_passing,"#3b82f6"],["Tackling",c.avg_tackling,"#10b981"],["GK",c.gk_rating,"#f59e0b"]];
  return `<div class="modal-overlay" onclick="closeModal()"><div class="modal" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <h2>Club #${c.club_id} <span style="font-size:13px;color:var(--text2)">(${c.country_id})</span></h2>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px">
      ${stats.map(([l,v])=>`<div class="stat-box"><div class="stat-label">${l}</div><div class="stat-val">${v??"‚Äî"}</div></div>`).join("")}
    </div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
      ${skills.map(([l,v,cl])=>`<div style="flex:1;min-width:90px"><div class="stat-label">${l}</div>${barHTML(v,100,cl)}</div>`).join("")}
    </div>
    ${c.manager_name?`<div style="font-size:12px;color:var(--text2)">Manager: <span style="color:var(--purple2);font-weight:600">${c.manager_name}</span></div>`:""}
  </div></div>`;
}

function renderLeagues() {
  if (state.loading) return `<div class="spinner"><div class="spinner-ring"></div></div>`;
  if (!state.leagues.length&&!state.error) return `<div class="empty"><div class="empty-icon">üèÜ</div>No leagues loaded.</div>`;
  let h = `<div class="grid grid-leagues">`;
  for (const l of state.leagues) {
    h += `<div class="card" onclick="openLeague(${l.league_id})">
      <div style="display:flex;justify-content:space-between;margin-bottom:10px">
        <div><div style="font-weight:700;font-size:15px;color:#f1f0f5">üèÜ ${l.country_id} ‚Äî Div ${l.division}</div><div style="font-size:11px;color:var(--text2)">${l.num_teams} teams ¬∑ Rd ${l.round}/${l.num_rounds}</div></div>
        <div style="text-align:right"><div style="font-size:9px;color:var(--text3);text-transform:uppercase">Mkt Cap</div><div style="color:var(--purple2);font-weight:700;font-size:14px">${fmtSVC(l.market_cap)}</div></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;font-size:10px">
        ${[["Prize",l.prize_money_pot],["TV",l.tv_money],["Wages",l.avg_wages],["7d Vol",l.total_volume_7_day]].map(([lb,v])=>`<div><div style="color:var(--text3);font-size:8px;text-transform:uppercase">${lb}</div><div style="color:var(--text);font-weight:600;margin-top:2px">${fmtSVC(v)}</div></div>`).join("")}
      </div>
      <div style="margin-top:10px;display:flex;align-items:center;gap:6px">${sparkSVG(l.last_7days,100,20,"#10b981")}<span style="font-size:9px;color:var(--text3)">View table ‚Üí</span></div>
    </div>`;
  }
  h += `</div>`;
  return h;
}

function renderLeagueModal() {
  const l = state.modal?.data;
  if (!l) return "";
  const rows = [...state.leagueTable].sort((a,b)=>a.new_position-b.new_position);
  let tbody = "";
  if (state.loading) tbody = `<tr><td colspan="10"><div class="spinner"><div class="spinner-ring"></div></div></td></tr>`;
  else if (!rows.length) tbody = `<tr><td colspan="10" style="text-align:center;color:var(--text2);padding:30px">No standings data.</td></tr>`;
  else tbody = rows.map((r,i)=>`<tr class="${i===0?'top':i%2===0?'stripe':''}">
    <td style="color:${i<2?'var(--green)':'var(--text)'};font-weight:700">${r.new_position}</td>
    <td style="color:var(--text);font-weight:600">#${r.club_id}${r.manager_name?`<span style="font-size:9px;color:var(--text3);margin-left:6px">(${r.manager_name})</span>`:""}</td>
    <td style="text-align:center;color:var(--text2)">${r.played}</td>
    <td style="text-align:center;color:var(--green)">${r.won}</td>
    <td style="text-align:center;color:var(--yellow)">${r.drawn}</td>
    <td style="text-align:center;color:var(--red)">${r.lost}</td>
    <td style="text-align:center;color:var(--text2)">${r.goals_for}</td>
    <td style="text-align:center;color:var(--text2)">${r.goals_against}</td>
    <td style="text-align:center;color:#f1f0f5;font-weight:800;font-size:14px">${r.pts}</td>
    <td>${formHTML(r.form)}</td>
  </tr>`).join("");
  return `<div class="modal-overlay" onclick="closeModal()"><div class="modal modal-wide" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <h2>${l.country_id} ‚Äî Division ${l.division}</h2>
    <div style="overflow-x:auto"><table><thead><tr>
      <th style="text-align:left">#</th><th style="text-align:left">Club</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th><th>Pts</th><th>Form</th>
    </tr></thead><tbody>${tbody}</tbody></table></div>
  </div></div>`;
}

function renderMarket() {
  if (state.loading) return `<div class="spinner"><div class="spinner-ring"></div></div>`;
  if (!state.market&&!state.error) return `<div class="empty"><div class="empty-icon">üìä</div>Loading...</div>`;
  if (!state.market) return "";
  const m = state.market;
  const items = [
    {l:"Total Market Cap",v:fmtSVC(m.TotalMarketCap),c:"var(--purple2)",i:"üíé"},
    {l:"7-Day Volume",v:fmtSVC(m.Total7dayVolume),c:"var(--green)",i:"üìà"},
    {l:"Total Players",v:fmt(m.TotalPlayers),c:"var(--blue)",i:"‚öΩ"},
    {l:"Players Mkt Cap",v:fmtSVC(m.PlayersMarketCap),c:"var(--purple)",i:"üí∞"},
    {l:"Total Clubs",v:fmt(m.TotalClubs),c:"var(--yellow)",i:"üèü"},
    {l:"Clubs Mkt Cap",v:fmtSVC(m.ClubsMarketCap),c:"var(--yellow)",i:"üè¶"},
    {l:"Club Balances",v:fmtSVC(m.ClubBalances),c:"var(--cyan)",i:"üíµ"},
    {l:"User Balances",v:fmtSVC(m.UserBalances),c:"var(--green)",i:"üë§"},
    {l:"Total Users",v:fmt(m.NumberOfUsers),c:"var(--text2)",i:"üë•"},
    {l:"Active Users",v:fmt(m.ActiveUsers),c:"var(--green)",i:"üü¢"},
    {l:"Active Managers",v:fmt(m.ActiveManagers),c:"var(--purple)",i:"üßë‚Äçüíº"},
    {l:"Agents",v:fmt(m.NumberAgents),c:"var(--orange)",i:"ü§ù"},
    {l:"SVC‚ÜíUSDC",v:m.SVC2USDC?.toFixed(6)??"‚Äî",c:"var(--purple2)",i:"üí±"},
  ];
  return `<div class="grid grid-market">${items.map(x=>`<div class="market-card"><div class="market-icon">${x.i}</div><div class="market-label">${x.l}</div><div class="market-val" style="color:${x.c}">${x.v}</div></div>`).join("")}</div>`;
}

function paginationHTML(page, total, pp, fn) {
  const tp = Math.ceil(total/pp);
  if (tp<=1) return "";
  return `<div class="pagination"><button class="pg-btn" ${page<=1?"disabled":""} onclick="${fn}(${page-1})">‚Üê Prev</button><span class="pg-info">${page} / ${tp}</span><button class="pg-btn" ${page>=tp?"disabled":""} onclick="${fn}(${page+1})">Next ‚Üí</button></div>`;
}

// ---- Event handlers ----
window.switchTab = function(t) { setState({tab:t, modal:null, error:null}); loadData(); };
window.updateFilter = function(key, val) { state[key]=val; state.playerPage=1; loadData(); };
window.toggleOrder = function() { state.playerOrder=state.playerOrder==="desc"?"asc":"desc"; state.playerPage=1; loadData(); };
window.setPlayerPage = function(p) { state.playerPage=p; loadData(); };
window.setClubPage = function(p) { state.clubPage=p; loadData(); };

let searchTimeout = null;
window.debounceSearch = function(val) {
  state.playerSearch = val;
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(()=>{ state.playerPage=1; loadData(); }, 500);
};

window.openPlayer = function(id) { const p=state.players.find(x=>x.player_id===id); if(p) setState({modal:{type:"player",data:p}}); };
window.openClub = function(id) { const c=state.clubs.find(x=>x.club_id===id); if(c) setState({modal:{type:"club",data:c}}); };
window.openLeague = function(id) { const l=state.leagues.find(x=>x.league_id===id); if(l) loadLeagueTable(l); };
window.closeModal = function() { setState({modal:null}); };

render();
loadData();
</script>
</body>
</html>
